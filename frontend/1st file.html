
<!DOCTYPE html>
<html>
<head>
    <title>MEDIFIND</title>
    <style>
        body { font-family: Arial; text-align: center; background:pink; }
        h1 { font-size:48px; color:#0066cc; margin:20px 0; font-weight:bold; text-shadow:2px 2px 4px rgba(0,0,0,0.1); }
        p { font-size:24px; color:#333; margin:10px 0; }
        .icons { display:flex; flex-wrap:wrap; justify-content:center; }
        .icons .icon-button { background:transparent; border:none; margin:10px; padding:0; cursor:pointer; border-radius:16px; outline-offset:4px; }
        .icons .icon-button img { width:150px; display:block; border-radius:15px; }
        .icons .icon-button:hover img, .icons .icon-button:focus img { box-shadow:0 6px 18px rgba(0,0,0,0.2); transform:translateY(-4px); transition:all 180ms ease; }
        .icons .icon-button:focus { box-shadow:0 0 0 4px rgba(255,255,255,0.6); }
        #doctor-list button { margin:5px; padding:5px 10px; }
        #history { position:fixed; right:0; top:0; width:200px; background:#ffe0e0; height:100%; padding:10px; overflow:auto;}
        .doctor-card { display:flex; align-items:center; background:#fff; border-radius:12px; padding:16px; margin:12px auto; max-width:600px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
        .doctor-card img { width:100px; height:100px; border-radius:12px; object-fit:cover; margin-right:16px; flex-shrink:0; }
        .doctor-info { text-align:left; flex-grow:1; }
        .doctor-info h4 { margin:0 0 8px 0; color:#333; font-size:18px; }
        .doctor-info p { margin:4px 0; color:#666; font-size:14px; }
        #content { padding:20px 0; }
        .doctor-card.selected { background:#ffd1dc; border:2px solid #ff69b4; }
        .booking-form { background:#fff; border-radius:12px; padding:20px; margin:20px auto; max-width:600px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
        .custom-modal { position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#4CAF50; color:#fff; padding:30px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.2); max-width:500px; z-index:2000; text-align:center; font-size:16px; line-height:1.6; }
        .custom-modal h3 { margin-top:0; font-size:20px; }
        .custom-modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1999; }
        .custom-modal button { background:#fff; color:#4CAF50; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; margin-top:15px; font-size:14px; font-weight:bold; }
    </style>
</head>

<body>

<h1>MEDIFIND</h1>
<p>Appointments Made Easy</p>

<h2>Select Body Part</h2>

<div class="icons">
    <button class="icon-button" aria-label="Eye specialists" onclick="loadDoctors('eye')"><img src="EYE1.png" alt="Eye"></button>
    <button class="icon-button" aria-label="Gynaecologists" onclick="loadDoctors('gynac')"><img src="GYNAC2.png" alt="Gynaecology"></button>
    <button class="icon-button" aria-label="Joints specialists" onclick="loadDoctors('joints')"><img src="JOINTS3.png" alt="Joints"></button>
    <button class="icon-button" aria-label="Hair specialists" onclick="loadDoctors('hair')"><img src="HAIR4.png" alt="Hair"></button>
    <button class="icon-button" aria-label="ENT specialists" onclick="loadDoctors('ent')"><img src="ENT5.png" alt="ENT"></button>
    <button class="icon-button" aria-label="Dentists" onclick="loadDoctors('teeth')"><img src="DENTIST6.png" alt="Dentist"></button>
</div>

<div id="content"></div>

<h3>Book Appointment</h3>
<input type="date" id="date">
<input type="time" id="time">
<button onclick="book()">Book</button>

    <button id="history-toggle" aria-expanded="false" title="Show history" style="position:fixed; right:10px; top:10px; z-index:1000; padding:8px 12px; border-radius:8px; background:#fff2f2; border:1px solid #ffc7c7; cursor:pointer;">History</button>

    <div id="history-panel" style="display:none; position:fixed; right:10px; top:50px; width:260px; background:#ffecec; height:70%; padding:12px; overflow:auto; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); z-index:1000;">
        <h3>History</h3>
        <ul id="history-list"></ul>
    </div>

<script>
let selectedDoctor = "";
let selectedCategory = "";

function loadDoctors(category){
    selectedCategory = category;

    fetch(`http://localhost:5000/api/doctors?category=${category}`)
    .then(res => res.json())
    .then(data => {
        const rows = data.doctors || [];
        const container = document.getElementById("content");
        
        if (!rows.length) {
            container.innerHTML = `<h3>${category.toUpperCase()}</h3><p>No records found.</p>`;
            return;
        }

        let html = `<h3>${category.toUpperCase()} - Doctors</h3>`;
        
        rows.forEach((row, idx) => {
            // Adjust indices based on actual database column order:
            // [ phoe,name, clinic, degree, photo_url, ...]
            const phone = row[0] || 'Unknown';
            const name = row[1] || 'N/A';
            const clinic = row[2] || 'N/A';
            const degree = row[3] || 'N/A';
            const photo = row[4] || 'placeholder.png';
            
            html += `
                <div class="doctor-card" onclick="selectDoctor('${name}', '${phone}', '${clinic}', '${degree}', '${idx}')" style="cursor:pointer; transition:all 200ms ease;">
                    <img src="${photo}" alt="${name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-family=%22Arial%22 font-size=%2214%22 fill=%22%23999%22%3ENo Photo%3C/text%3E%3C/svg%3E'">
                    <div class="doctor-info">
                        <p><strong>Phone:</strong> ${phone}</p>
                        <h4>${name}</h4>
                        <p><strong>Clinic:</strong> ${clinic}</p>
                        <p><strong>Degree:</strong> ${degree}</p>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    });
}

function showCustomModal(message) {
    // Remove any existing modal
    const existing = document.getElementById('custom-modal-overlay');
    if (existing) existing.remove();
    
    const overlay = document.createElement('div');
    overlay.id = 'custom-modal-overlay';
    overlay.className = 'custom-modal-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'custom-modal';
    
    const lines = message.split('\n');
    let htmlContent = '';
    lines.forEach((line, idx) => {
        if (line.trim() !== '') {
            if (idx === 0) {
                htmlContent += `<h3>${line}</h3>`;
            } else {
                htmlContent += `<p>${line}</p>`;
            }
        }
    });
    htmlContent += '<button onclick="closeCustomModal()">OK</button>';
    
    modal.innerHTML = htmlContent;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

function closeCustomModal() {
    const overlay = document.getElementById('custom-modal-overlay');
    if (overlay) overlay.remove();
}

function selectDoctor(name, phone, clinic, degree, idx){
    selectedDoctor = name;
    
    // Highlight selected card
    const cards = document.querySelectorAll('.doctor-card');
    cards.forEach((card, i) => {
        if (i == idx) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });
    
    // Show booking form
    let formHtml = `
        <div class="booking-form">
            <h3>Book Appointment with ${name}</h3>
            <p><strong>Clinic:</strong> ${clinic}</p>
            <p><strong>Phone:</strong> ${phone}</p>
            <label>Date: <input type="date" id="appt-date" style="padding:6px; border:1px solid #ccc; border-radius:6px;"></label><br><br>
            <label>Time: <input type="time" id="appt-time" style="padding:6px; border:1px solid #ccc; border-radius:6px;"></label><br><br>
            <button onclick="book()" style="padding:8px 16px; background:#ff69b4; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px;">Book Appointment</button>
            <button onclick="cancelBooking()" style="padding:8px 16px; background:#ccc; color:#333; border:none; border-radius:6px; cursor:pointer; margin-left:8px; font-size:14px;">Cancel</button>
        </div>
    `;
    
    // Insert form after content
    let existing = document.getElementById('booking-form');
    if (existing) existing.remove();
    
    const container = document.getElementById("content");
    container.insertAdjacentHTML('afterend', `<div id="booking-form">${formHtml}</div>`);
}

function cancelBooking(){
    const form = document.getElementById('booking-form');
    if (form) form.remove();
    
    // Deselect all cards
    const cards = document.querySelectorAll('.doctor-card');
    cards.forEach(card => card.classList.remove('selected'));
    selectedDoctor = "";
}

function book(){
    const date = document.getElementById("appt-date").value;
    const time = document.getElementById("appt-time").value;

    if(!selectedDoctor){
        alert("Select a doctor first");
        return;
    }

    if (!date || !time) {
        alert("Please select both date and time");
        return;
    }

    fetch("http://localhost:5000/api/appointments", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            doctor:selectedDoctor,
            body_part:selectedCategory,
            appt_date:date,
            appt_time:time
        })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            const li = document.createElement("li");
            li.textContent = selectedDoctor + " | " + date + " " + time;
            const hlist = document.getElementById("history-list");
            const placeholder = hlist.querySelector('.empty-placeholder');
            if (placeholder) placeholder.remove();
            hlist.appendChild(li);
            alert("âœ“ Appointment booked successfully!\n\nYou will receive a push notification reminder the day before your appointment.\n\nThank you for using MediFind. Have a good visit!");
            cancelBooking();
        } else {
            alert("Error booking.");
        }
    });
}

function toggleHistory(){
    const panel = document.getElementById('history-panel');
    const btn = document.getElementById('history-toggle');
    if(!panel) return;
    const isHidden = panel.style.display === 'none' || panel.style.display === '';
    panel.style.display = isHidden ? 'block' : 'none';
    if (isHidden) {
        const hlist = document.getElementById('history-list');
        if (!hlist) return;
        hlist.innerHTML = '<li class="empty-placeholder">Loading...</li>';
        fetch('http://localhost:5000/api/appointments')
            .then(r => r.json())
            .then(data => {
                hlist.innerHTML = '';
                const rows = data.appointments || [];
                if (!rows.length) {
                    hlist.innerHTML = '<li class="empty-placeholder">No Recipts</li>';
                    return;
                }
                rows.forEach(rw => {
                    const li = document.createElement('li');
                    // rw: [doctor, body_part, appt_date, appt_time, created_at]
                    li.textContent = `${rw[0]} | ${rw[2]} ${rw[3]}`;
                    hlist.appendChild(li);
                });
            })
            .catch(err => {
                hlist.innerHTML = '<li class="empty-placeholder">Failed to load</li>';
                console.error(err);
            });
    }
    btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
}

// attach click handler for the history button if present
document.addEventListener('DOMContentLoaded', () => {
    const hbtn = document.getElementById('history-toggle');
    if (hbtn) hbtn.addEventListener('click', toggleHistory);
});
</script>

</body>
</html>